<!DOCTYPE html>
<html>
  <head>
    <title>School Air Quality Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      #map {
        height: 100vh;
        width: 100%;
      }
      .search-box {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }
      .search-box input {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
        width: 250px;
      }
      .legend {
        position: absolute;
        bottom: 30px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        font-size: 12px;
      }
      .legend h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
      }
      .legend-item {
        margin: 5px 0;
      }
      .legend-color {
        display: inline-block;
        width: 20px;
        height: 20px;
        margin-right: 5px;
        border-radius: 50%;
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search schools..." />
    </div>

    <div class="legend">
      <h4>PM10 Levels (µg/m³)</h4>
      <div class="legend-item">
        <span class="legend-color" style="background: #00ff00"></span>
        Good (0-20)
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background: #ffff00"></span>
        Moderate (20-40)
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background: #ff9900"></span>
        Poor (40-50)
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background: #ff0000"></span>
        Very Poor (50+)
      </div>
    </div>

    <div id="map"></div>

    <!-- Embed JSON data using Django's json_script filter -->
    {{ schools_data|json_script:"schools-data" }}

    <script>
      // Use Django's json_script filter to safely pass data

      const schoolsData = JSON.parse(
        document.getElementById("schools-data").textContent
      );

      // DEBUG: Check if schools loaded
      console.log("Schools loaded:", schoolsData);
      console.log("Number of schools:", schoolsData.length);

      // Initialize map centered on London/Camberwell area
      const map = L.map("map").setView([51.48, -0.09], 13);

      // Add OpenStreetMap tiles
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      // Store markers for search functionality
      let markers = [];

      // Function to get color based on PM10 value
      function getColor(pm10) {
        if (pm10 === null || pm10 === undefined) return "#808080"; // Gray for no data
        if (pm10 <= 20) return "#00ff00"; // Green - Good
        if (pm10 <= 40) return "#ffff00"; // Yellow - Moderate
        if (pm10 <= 50) return "#ff9900"; // Orange - Poor
        return "#ff0000"; // Red - Very Poor
      }

      // Add markers for each school
      schoolsData.forEach((school) => {
        console.log("Processing school:", school.name);

        const pm10 = school.readings.PM10;
        const no2 = school.readings.NO2;

        const color = getColor(pm10);

        const marker = L.circleMarker([school.latitude, school.longitude], {
          radius: 10,
          fillColor: color,
          color: "#000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8,
        }).addTo(map);

        // Popup content
        let popupContent = `
              <strong>${school.name}</strong><br>
              ${school.address}<br><br>
              <strong>Air Quality:</strong><br>
          `;

        if (pm10 !== null && pm10 !== undefined) {
          popupContent += `PM10: ${pm10.toFixed(1)} µg/m³<br>`;
        }
        if (no2 !== null && no2 !== undefined) {
          popupContent += `NO₂: ${no2.toFixed(1)} µg/m³<br>`;
        }

        if (
          (pm10 === null || pm10 === undefined) &&
          (no2 === null || no2 === undefined)
        ) {
          popupContent += "<em>No recent data available</em>";
        }

        marker.bindPopup(popupContent);

        // Store marker with school info for search
        markers.push({
          marker: marker,
          school: school,
        });
      });

      console.log("Total markers added:", markers.length);

      // Search functionality
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("input", function (e) {
        const searchTerm = e.target.value.toLowerCase();

        markers.forEach((item) => {
          const schoolName = item.school.name.toLowerCase();
          const address = item.school.address.toLowerCase();

          if (searchTerm === "") {
            item.marker.setStyle({ radius: 10, opacity: 1, fillOpacity: 0.8 });
          } else if (
            schoolName.includes(searchTerm) ||
            address.includes(searchTerm)
          ) {
            item.marker.setStyle({ radius: 15, opacity: 1, fillOpacity: 1 });
            item.marker.openPopup();
            map.setView([item.school.latitude, item.school.longitude], 15);
          } else {
            item.marker.setStyle({ radius: 8, opacity: 0.3, fillOpacity: 0.3 });
          }
        });
      });
    </script>
  </body>
</html>
