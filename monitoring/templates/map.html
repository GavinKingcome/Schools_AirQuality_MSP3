{% extends 'base.html' %}

{% block title %}Map View - Schools Pollution Monitor{% endblock %}

{% block extra_css %}
<style>
  #map {
    height: calc(100vh - 180px);
    width: 100%;
    position: relative;
  }

  .search-box {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
  }

  .search-box input {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 3px;
    width: 250px;
    font-size: 14px;
  }

  .search-box input:focus {
    outline: none;
    border-color: #0078a8;
    box-shadow: 0 0 5px rgba(0, 120, 168, 0.3);
  }

  @media (max-width: 768px) {
    .leaflet-top.leaflet-left {
      top: 70px !important;
    }

    #map {
      height: calc(100vh - 220px);
    }

    .search-box {
      top: 10px;
      left: 10px;
      right: 10px;
      width: auto;
    }

    .search-box input {
      width: 100%;
      box-sizing: border-box;
    }
  }

  @media (max-width: 480px) {
    #map {
      height: calc(100vh - 200px);
    }
  }
</style>
{% endblock %}

{% block content %}
<div id="map">
  <div class="search-box">
    <input
      type="text"
      id="searchInput"
      list="schoolsList"
      placeholder="Search schools..."
      spellcheck="false"
    />
    <datalist id="schoolsList"></datalist>
  </div>
</div>

{{ schools_data|json_script:"schools-data" }}
{% endblock %}

{% block extra_js %}

<script>
  const schoolsData = JSON.parse(
    document.getElementById("schools-data").textContent
  );
  console.log("Schools loaded:", schoolsData);
  console.log("Number of schools:", schoolsData.length);

  const map = L.map("map").setView([51.48, -0.09], 13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution:
      '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | Data: <a href="https://openaq.org">OpenAQ</a>',
  }).addTo(map);

  let markers = [];

  function getPM10Category(pm10) {
    if (pm10 === null || pm10 === undefined) return null;
    if (pm10 <= 20) return 1;
    if (pm10 <= 40) return 2;
    if (pm10 <= 50) return 3;
    return 4;
  }

  function getNO2Category(no2) {
    if (no2 === null || no2 === undefined) return null;
    if (no2 <= 40) return 1;
    if (no2 <= 100) return 2;
    if (no2 <= 200) return 3;
    return 4;
  }

  function getAirQualityColor(pm10, no2) {
    const pm10Cat = getPM10Category(pm10);
    const no2Cat = getNO2Category(no2);
    if (pm10Cat === null && no2Cat === null) return "#808080";
    const worstCategory = Math.max(pm10Cat || 0, no2Cat || 0);
    switch (worstCategory) {
      case 1:
        return "#00a651";
      case 2:
        return "#ffa500";
      case 3:
        return "#ff6b35";
      case 4:
        return "#d32f2f";
      default:
        return "#808080";
    }
  }

  function getCategoryInfo(pm10, no2) {
    const pm10Cat = getPM10Category(pm10);
    const no2Cat = getNO2Category(no2);
    const worstCategory = Math.max(pm10Cat || 0, no2Cat || 0);
    const categories = {
      1: { name: "Good", color: "#00a651" },
      2: { name: "Moderate", color: "#ffa500" },
      3: { name: "Poor", color: "#ff6b35" },
      4: { name: "Very Poor", color: "#d32f2f" },
    };
    return categories[worstCategory] || { name: "No data", color: "#808080" };
  }

  const datalist = document.getElementById("schoolsList");
  schoolsData.forEach((school) => {
    const option = document.createElement("option");
    option.value = school.name;
    datalist.appendChild(option);
  });

  schoolsData.forEach((school) => {
    const pm10 = school.readings.PM10;
    const no2 = school.readings.NO2;
    const color = getAirQualityColor(pm10, no2);
    const categoryInfo = getCategoryInfo(pm10, no2);

    const marker = L.circleMarker([school.latitude, school.longitude], {
      radius: 12,
      fillColor: color,
      color: "#000",
      weight: 2,
      opacity: 1,
      fillOpacity: 0.85,
    }).addTo(map);

    let popupContent = `<div style="min-width: 200px;"><strong style="font-size: 16px;">${school.name}</strong><br><span style="color: #666; font-size: 13px;">${school.address}</span><hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;"><div style="background: ${categoryInfo.color}; color: white; padding: 8px; border-radius: 4px; text-align: center; margin-bottom: 10px; font-weight: bold;">Air Quality: ${categoryInfo.name}</div>`;

    if (pm10 !== null && pm10 !== undefined) {
      const pm10Info = getCategoryInfo(pm10, null);
      popupContent += `<div style="margin: 8px 0; padding: 6px; background: #f5f5f5; border-radius: 3px;"><strong>PM10:</strong> ${pm10.toFixed(
        1
      )} µg/m³ <span style="color: ${pm10Info.color}; font-weight: bold;">● ${
        pm10Info.name
      }</span></div>`;
    }
    if (no2 !== null && no2 !== undefined) {
      const no2Info = getCategoryInfo(null, no2);
      popupContent += `<div style="margin: 8px 0; padding: 6px; background: #f5f5f5; border-radius: 3px;"><strong>NO₂:</strong> ${no2.toFixed(
        1
      )} µg/m³ <span style="color: ${no2Info.color}; font-weight: bold;">● ${
        no2Info.name
      }</span></div>`;
    }

    if (
      (pm10 === null || pm10 === undefined) &&
      (no2 === null || no2 === undefined)
    ) {
      popupContent += '<em style="color: #999;">No recent data available</em>';
    }

    popupContent += "</div>";
    marker.bindPopup(popupContent);
    markers.push({ marker: marker, school: school });
  });

  const searchInput = document.getElementById("searchInput");
  searchInput.addEventListener("input", function (e) {
    const searchTerm = e.target.value.toLowerCase();
    markers.forEach((item) => {
      item.marker.setStyle({ radius: 12, opacity: 1, fillOpacity: 0.85 });
    });

    if (searchTerm !== "") {
      markers.forEach((item) => {
        const schoolName = item.school.name.toLowerCase();
        const address = item.school.address.toLowerCase();
        if (schoolName.includes(searchTerm) || address.includes(searchTerm)) {
          item.marker.setStyle({ radius: 16, opacity: 1, fillOpacity: 1 });
          if (schoolName === searchTerm) {
            item.marker.openPopup();
            map.setView([item.school.latitude, item.school.longitude], 15);
          }
        } else {
          item.marker.setStyle({ radius: 10, opacity: 0.3, fillOpacity: 0.3 });
        }
      });
    }
  });

  searchInput.addEventListener("change", function (e) {
    const selectedSchool = e.target.value;
    markers.forEach((item) => {
      if (item.school.name === selectedSchool) {
        item.marker.setStyle({ radius: 16, opacity: 1, fillOpacity: 1 });
        item.marker.openPopup();
        map.setView([item.school.latitude, item.school.longitude], 15);
      }
    });
  });
</script>
{% endblock %}
